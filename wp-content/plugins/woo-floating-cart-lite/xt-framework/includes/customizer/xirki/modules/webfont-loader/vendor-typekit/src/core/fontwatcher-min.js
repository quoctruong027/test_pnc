goog.provide("webfont.FontWatcher");goog.require("webfont.FontWatchRunner");goog.require("webfont.NativeFontWatchRunner");webfont.FontTestStrings;webfont.FontWatcher=function(domHelper,eventDispatcher,opt_timeout){this.domHelper_=domHelper;this.eventDispatcher_=eventDispatcher;this.currentlyWatched_=0;this.last_=false;this.success_=false;this.timeout_=opt_timeout};goog.scope(function(){var FontWatcher=webfont.FontWatcher,FontWatchRunner=webfont.FontWatchRunner,NativeFontWatchRunner=webfont.NativeFontWatchRunner;FontWatcher.SHOULD_USE_NATIVE_LOADER=null;FontWatcher.getUserAgent=function(){return window.navigator.userAgent};FontWatcher.getVendor=function(){return window.navigator.vendor};FontWatcher.shouldUseNativeLoader=function(){if(FontWatcher.SHOULD_USE_NATIVE_LOADER===null){if(!!window.FontFace){var match=/Gecko.*Firefox\/(\d+)/.exec(FontWatcher.getUserAgent());var safari10Match=/OS X.*Version\/10\..*Safari/.exec(FontWatcher.getUserAgent())&&/Apple/.exec(FontWatcher.getVendor());if(match){FontWatcher.SHOULD_USE_NATIVE_LOADER=parseInt(match[1],10)>42}else if(safari10Match){FontWatcher.SHOULD_USE_NATIVE_LOADER=false}else{FontWatcher.SHOULD_USE_NATIVE_LOADER=true}}else{FontWatcher.SHOULD_USE_NATIVE_LOADER=false}}return FontWatcher.SHOULD_USE_NATIVE_LOADER};FontWatcher.prototype.watchFonts=function(fonts,fontTestStrings,metricCompatibleFonts,last){var length=fonts.length,testStrings=fontTestStrings||{};if(length===0&&last){this.eventDispatcher_.dispatchInactive();return}this.currentlyWatched_+=fonts.length;if(last){this.last_=last}var i,fontWatchRunners=[];for(i=0;i<fonts.length;i++){var font=fonts[i],testString=testStrings[font.getName()];this.eventDispatcher_.dispatchFontLoading(font);var fontWatchRunner=null;if(FontWatcher.shouldUseNativeLoader()){fontWatchRunner=new NativeFontWatchRunner(goog.bind(this.fontActive_,this),goog.bind(this.fontInactive_,this),this.domHelper_,font,this.timeout_,testString)}else{fontWatchRunner=new FontWatchRunner(goog.bind(this.fontActive_,this),goog.bind(this.fontInactive_,this),this.domHelper_,font,this.timeout_,metricCompatibleFonts,testString)}fontWatchRunners.push(fontWatchRunner)}for(i=0;i<fontWatchRunners.length;i++){fontWatchRunners[i].start()}};FontWatcher.prototype.fontActive_=function(font){this.eventDispatcher_.dispatchFontActive(font);this.success_=true;this.decreaseCurrentlyWatched_()};FontWatcher.prototype.fontInactive_=function(font){this.eventDispatcher_.dispatchFontInactive(font);this.decreaseCurrentlyWatched_()};FontWatcher.prototype.decreaseCurrentlyWatched_=function(){if(--this.currentlyWatched_==0&&this.last_){if(this.success_){this.eventDispatcher_.dispatchActive()}else{this.eventDispatcher_.dispatchInactive()}}}});