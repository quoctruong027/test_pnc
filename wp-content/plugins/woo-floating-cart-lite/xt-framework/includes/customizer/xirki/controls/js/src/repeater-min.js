var RepeaterRow=function(rowIndex,container,label,control){"use strict";var self=this;this.rowIndex=rowIndex;this.container=container;this.label=label;this.header=this.container.find(".repeater-row-header");this.header.on("click",function(){self.toggleMinimize()});this.container.on("click",".repeater-row-remove",function(){self.remove()});this.header.on("mousedown",function(){self.container.trigger("row:start-dragging")});this.container.on("keyup change","input, select, textarea",function(e){self.container.trigger("row:update",[self.rowIndex,jQuery(e.target).data("field"),e.target])});this.setRowIndex=function(rowIndex){this.rowIndex=rowIndex;this.container.attr("data-row",rowIndex);this.container.data("row",rowIndex);this.updateLabel()};this.toggleMinimize=function(){this.container.toggleClass("minimized");this.header.find(".dashicons").toggleClass("dashicons-arrow-up").toggleClass("dashicons-arrow-down")};this.remove=function(){this.container.slideUp(300,function(){jQuery(this).detach()});this.container.trigger("row:remove",[this.rowIndex])};this.updateLabel=function(){var rowLabelField,rowLabel,rowLabelSelector;if("field"===this.label.type){rowLabelField=this.container.find('.repeater-field [data-field="'+this.label.field+'"]');if(_.isFunction(rowLabelField.val)){rowLabel=rowLabelField.val();if(""!==rowLabel){if(!_.isUndefined(control.params.fields[this.label.field])){if(!_.isUndefined(control.params.fields[this.label.field].type)){if("select"===control.params.fields[this.label.field].type){if(!_.isUndefined(control.params.fields[this.label.field].choices)&&!_.isUndefined(control.params.fields[this.label.field].choices[rowLabelField.val()])){rowLabel=control.params.fields[this.label.field].choices[rowLabelField.val()]}}else if("radio"===control.params.fields[this.label.field].type||"radio-image"===control.params.fields[this.label.field].type){rowLabelSelector=control.selector+' [data-row="'+this.rowIndex+'"] .repeater-field [data-field="'+this.label.field+'"]:checked';rowLabel=jQuery(rowLabelSelector).val()}}}this.header.find(".repeater-row-label").text(rowLabel);return}}}this.header.find(".repeater-row-label").text(this.label.value+" "+(this.rowIndex+1))};this.updateLabel()};wp.customize.controlConstructor.repeater=wp.customize.Control.extend({ready:function(){"use strict";var control=this;if(!_.isUndefined(window.xirkiControlLoader)&&_.isFunction(xirkiControlLoader)){xirkiControlLoader(control)}else{control.initXirkiControl()}},initXirkiControl:function(){"use strict";var control=this,limit,theNewRow;var settingValue=this.params.value;this.settingField=this.container.find("[data-customize-setting-link]").first();this.setValue([],false);this.repeaterFieldsContainer=this.container.find(".repeater-fields").first();this.currentIndex=0;this.rows=[];limit=false;if(!_.isUndefined(this.params.choices.limit)){limit=0>=this.params.choices.limit?false:parseInt(this.params.choices.limit,10)}this.container.on("click","button.repeater-add",function(e){e.preventDefault();if(!limit||control.currentIndex<limit){theNewRow=control.addRow();theNewRow.toggleMinimize();control.initColorPicker();control.initSelect(theNewRow)}else{jQuery(control.selector+" .limit").addClass("highlight")}});this.container.on("click",".repeater-row-remove",function(){control.currentIndex--;if(!limit||control.currentIndex<limit){jQuery(control.selector+" .limit").removeClass("highlight")}});this.container.on("click keypress",".repeater-field-image .upload-button,.repeater-field-cropped_image .upload-button,.repeater-field-upload .upload-button",function(e){e.preventDefault();control.$thisButton=jQuery(this);control.openFrame(e)});this.container.on("click keypress",".repeater-field-image .remove-button,.repeater-field-cropped_image .remove-button",function(e){e.preventDefault();control.$thisButton=jQuery(this);control.removeImage(e)});this.container.on("click keypress",".repeater-field-upload .remove-button",function(e){e.preventDefault();control.$thisButton=jQuery(this);control.removeFile(e)});this.repeaterTemplate=_.memoize(function(){var compiled,options={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(data){compiled=_.template(control.container.find(".customize-control-repeater-content").first().html(),null,options);return compiled(data)}});if(settingValue.length){_.each(settingValue,function(subValue){theNewRow=control.addRow(subValue);control.initColorPicker();control.initSelect(theNewRow,subValue)})}this.setValue(settingValue,true,true);this.repeaterFieldsContainer.sortable({handle:".repeater-row-header",update:function(){control.sort()}})},openFrame:function(event){"use strict";if(wp.customize.utils.isKeydownButNotEnterEvent(event)){return}if(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-cropped_image")){this.initCropperFrame()}else{this.initFrame()}this.frame.open()},initFrame:function(){"use strict";var libMediaType=this.getMimeType();this.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query({type:libMediaType}),multiple:false,date:false})]});this.frame.on("select",this.onSelect,this)},initCropperFrame:function(){"use strict";var currentFieldId=this.$thisButton.siblings("input.hidden-field").attr("data-field"),attrs=["width","height","flex_width","flex_height"],libMediaType=this.getMimeType();if(_.isString(currentFieldId)&&""!==currentFieldId){if(_.isObject(this.params.fields[currentFieldId])&&"cropped_image"===this.params.fields[currentFieldId].type){attrs.forEach(function(el){if(!_.isUndefined(this.params.fields[currentFieldId][el])){this.params[el]=this.params.fields[currentFieldId][el]}}.bind(this))}}this.frame=wp.media({button:{text:"Select and Crop",close:false},states:[new wp.media.controller.Library({library:wp.media.query({type:libMediaType}),multiple:false,date:false,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]});this.frame.on("select",this.onSelectForCrop,this);this.frame.on("cropped",this.onCropped,this);this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){"use strict";var attachment=this.frame.state().get("selection").first().toJSON();if(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-upload")){this.setFileInRepeaterField(attachment)}else{this.setImageInRepeaterField(attachment)}},onSelectForCrop:function(){"use strict";var attachment=this.frame.state().get("selection").first().toJSON();if(this.params.width===attachment.width&&this.params.height===attachment.height&&!this.params.flex_width&&!this.params.flex_height){this.setImageInRepeaterField(attachment)}else{this.frame.setState("cropper")}},onCropped:function(croppedImage){"use strict";this.setImageInRepeaterField(croppedImage)},calculateImageSelectOptions:function(attachment,controller){"use strict";var control=controller.get("control"),flexWidth=!!parseInt(control.params.flex_width,10),flexHeight=!!parseInt(control.params.flex_height,10),realWidth=attachment.get("width"),realHeight=attachment.get("height"),xInit=parseInt(control.params.width,10),yInit=parseInt(control.params.height,10),ratio=xInit/yInit,xImg=realWidth,yImg=realHeight,x1,y1,imgSelectOptions;controller.set("canSkipCrop",!control.mustBeCropped(flexWidth,flexHeight,xInit,yInit,realWidth,realHeight));if(xImg/yImg>ratio){yInit=yImg;xInit=yInit*ratio}else{xInit=xImg;yInit=xInit/ratio}x1=(xImg-xInit)/2;y1=(yImg-yInit)/2;imgSelectOptions={handles:true,keys:true,instance:true,persistent:true,imageWidth:realWidth,imageHeight:realHeight,x1:x1,y1:y1,x2:xInit+x1,y2:yInit+y1};if(false===flexHeight&&false===flexWidth){imgSelectOptions.aspectRatio=xInit+":"+yInit}if(false===flexHeight){imgSelectOptions.maxHeight=yInit}if(false===flexWidth){imgSelectOptions.maxWidth=xInit}return imgSelectOptions},mustBeCropped:function(flexW,flexH,dstW,dstH,imgW,imgH){"use strict";if(true===flexW&&true===flexH||true===flexW&&dstH===imgH||true===flexH&&dstW===imgW||dstW===imgW&&dstH===imgH||imgW<=dstW){return false}return true},onSkippedCrop:function(){"use strict";var attachment=this.frame.state().get("selection").first().toJSON();this.setImageInRepeaterField(attachment)},setImageInRepeaterField:function(attachment){"use strict";var $targetDiv=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image");$targetDiv.find(".xirki-image-attachment").html('<img src="'+attachment.url+'">').hide().slideDown("slow");$targetDiv.find(".hidden-field").val(attachment.id);this.$thisButton.text(this.$thisButton.data("alt-label"));$targetDiv.find(".remove-button").show();$targetDiv.find("input, textarea, select").trigger("change");this.frame.close()},setFileInRepeaterField:function(attachment){"use strict";var $targetDiv=this.$thisButton.closest(".repeater-field-upload");$targetDiv.find(".xirki-file-attachment").html('<span class="file"><span class="dashicons dashicons-media-default"></span> '+attachment.filename+"</span>").hide().slideDown("slow");$targetDiv.find(".hidden-field").val(attachment.id);this.$thisButton.text(this.$thisButton.data("alt-label"));$targetDiv.find(".upload-button").show();$targetDiv.find(".remove-button").show();$targetDiv.find("input, textarea, select").trigger("change");this.frame.close()},getMimeType:function(){"use strict";var currentFieldId=this.$thisButton.siblings("input.hidden-field").attr("data-field");if(_.isString(currentFieldId)&&""!==currentFieldId){if(_.isObject(this.params.fields[currentFieldId])&&"upload"===this.params.fields[currentFieldId].type){if(!_.isUndefined(this.params.fields[currentFieldId].mime_type)){return this.params.fields[currentFieldId].mime_type}}}return"image"},removeImage:function(event){"use strict";var $targetDiv,$uploadButton;if(wp.customize.utils.isKeydownButNotEnterEvent(event)){return}$targetDiv=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image,.repeater-field-upload");$uploadButton=$targetDiv.find(".upload-button");$targetDiv.find(".xirki-image-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))});$targetDiv.find(".hidden-field").val("");$uploadButton.text($uploadButton.data("label"));this.$thisButton.hide();$targetDiv.find("input, textarea, select").trigger("change")},removeFile:function(event){"use strict";var $targetDiv,$uploadButton;if(wp.customize.utils.isKeydownButNotEnterEvent(event)){return}$targetDiv=this.$thisButton.closest(".repeater-field-upload");$uploadButton=$targetDiv.find(".upload-button");$targetDiv.find(".xirki-file-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))});$targetDiv.find(".hidden-field").val("");$uploadButton.text($uploadButton.data("label"));this.$thisButton.hide();$targetDiv.find("input, textarea, select").trigger("change")},getValue:function(){"use strict";return JSON.parse(decodeURI(this.setting.get()))},setValue:function(newValue,refresh,filtering){"use strict";var filteredValue=newValue,filter=[];if(filtering){jQuery.each(this.params.fields,function(index,value){if("image"===value.type||"cropped_image"===value.type||"upload"===value.type){filter.push(index)}});jQuery.each(newValue,function(index,value){jQuery.each(filter,function(ind,field){if(!_.isUndefined(value[field])&&!_.isUndefined(value[field].id)){filteredValue[index][field]=value[field].id}})})}this.setting.set(encodeURI(JSON.stringify(filteredValue)));if(refresh){this.settingField.trigger("change")}},addRow:function(data){"use strict";var control=this,template=control.repeaterTemplate(),settingValue=this.getValue(),newRowSetting={},templateData,newRow,i;if(template){templateData=jQuery.extend(true,{},control.params.fields);if(data){for(i in data){if(data.hasOwnProperty(i)&&templateData.hasOwnProperty(i)){templateData[i].default=data[i]}}}templateData.index=this.currentIndex;template=template(templateData);newRow=new RepeaterRow(control.currentIndex,jQuery(template).appendTo(control.repeaterFieldsContainer),control.params.row_label,control);newRow.container.on("row:remove",function(e,rowIndex){control.deleteRow(rowIndex)});newRow.container.on("row:update",function(e,rowIndex,fieldName,element){control.updateField.call(control,e,rowIndex,fieldName,element);newRow.updateLabel()});this.rows[this.currentIndex]=newRow;for(i in templateData){if(templateData.hasOwnProperty(i)){newRowSetting[i]=templateData[i].default}}settingValue[this.currentIndex]=newRowSetting;this.setValue(settingValue,true);this.currentIndex++;return newRow}},sort:function(){"use strict";var control=this,$rows=this.repeaterFieldsContainer.find(".repeater-row"),newOrder=[],settings=control.getValue(),newRows=[],newSettings=[];$rows.each(function(i,element){newOrder.push(jQuery(element).data("row"))});jQuery.each(newOrder,function(newPosition,oldPosition){newRows[newPosition]=control.rows[oldPosition];newRows[newPosition].setRowIndex(newPosition);newSettings[newPosition]=settings[oldPosition]});control.rows=newRows;control.setValue(newSettings)},deleteRow:function(index){"use strict";var currentSettings=this.getValue(),row,i,prop;if(currentSettings[index]){row=this.rows[index];if(row){delete currentSettings[index];delete this.rows[index];this.setValue(currentSettings,true)}}i=1;for(prop in this.rows){if(this.rows.hasOwnProperty(prop)&&this.rows[prop]){this.rows[prop].updateLabel();i++}}},updateField:function(e,rowIndex,fieldId,element){"use strict";var type,row,currentSettings;if(!this.rows[rowIndex]){return}if(!this.params.fields[fieldId]){return}type=this.params.fields[fieldId].type;row=this.rows[rowIndex];currentSettings=this.getValue();element=jQuery(element);if(_.isUndefined(currentSettings[row.rowIndex][fieldId])){return}if("checkbox"===type){currentSettings[row.rowIndex][fieldId]=element.is(":checked")}else{currentSettings[row.rowIndex][fieldId]=element.val()}this.setValue(currentSettings,true)},initColorPicker:function(){"use strict";var control=this,colorPicker=control.container.find(".color-picker-hex"),options={},fieldId=colorPicker.data("field");if(!_.isUndefined(fieldId)&&!_.isUndefined(control.params.fields[fieldId])&&!_.isUndefined(control.params.fields[fieldId].palettes)&&_.isObject(control.params.fields[fieldId].palettes)){options.palettes=control.params.fields[fieldId].palettes}options.change=function(event,ui){var currentPicker=jQuery(event.target),row=currentPicker.closest(".repeater-row"),rowIndex=row.data("row"),currentSettings=control.getValue();currentSettings[rowIndex][currentPicker.data("field")]=ui.color.toString();control.setValue(currentSettings,true)};if(0!==colorPicker.length){colorPicker.wpColorPicker(options)}},initSelect:function(theNewRow,data){"use strict";var control=this,dropdown=theNewRow.container.find(".repeater-field select"),$select,dataField,multiple,selectWooOptions={};if(0===dropdown.length){return}dataField=dropdown.data("field");multiple=jQuery(dropdown).data("multiple");if("undefed"!==multiple&&jQuery.isNumeric(multiple)){multiple=parseInt(multiple,10);if(1<multiple){selectWooOptions.maximumSelectionLength=multiple}}data=data||{};data[dataField]=data[dataField]||"";$select=jQuery(dropdown).selectWoo(selectWooOptions).val(data[dataField]||jQuery(dropdown).val());this.container.on("change",".repeater-field select",function(event){var currentDropdown=jQuery(event.target),row=currentDropdown.closest(".repeater-row"),rowIndex=row.data("row"),currentSettings=control.getValue();currentSettings[rowIndex][currentDropdown.data("field")]=jQuery(this).val();control.setValue(currentSettings)})}});